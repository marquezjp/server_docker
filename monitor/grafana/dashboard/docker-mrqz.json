{
  "title": "Docker — MRQZ",
  "uid": "docker-mrqz",
  "tags": ["Docker","CadVisor","Node-Exporter","Prometheus"],
  "timezone": "browser",
  "schemaVersion": 38,
  "version": 1,
  "style": "dark",
  "refresh": "15s",
  "editable": true,

  "__inputs": [
    {
      "name": "DS_PROMETHEUS",
      "label": "Prometheus",
      "type": "datasource",
      "pluginId": "prometheus",
      "pluginName": "Prometheus"
    }
  ],
  "__requires": [
    { "type": "grafana", "id": "grafana", "name": "Grafana", "version": "9.5.0" },
    { "type": "datasource", "id": "prometheus", "name": "Prometheus", "version": "2.9.0" },
    { "type": "panel", "id": "stat", "name": "Stat", "version": "" },
    { "type": "panel", "id": "gauge", "name": "Gauge", "version": "" },
    { "type": "panel", "id": "timeseries", "name": "Time series", "version": "" },
    { "type": "panel", "id": "table", "name": "Table", "version": "" },
    { "type": "panel", "id": "bargauge", "name": "Bar Gauge", "version": "" }
  ],

  "annotations": { "list": [
    {
      "builtIn": 1, "datasource": "-- Grafana --",
      "enable": true, "hide": true,
      "iconColor": "rgba(0, 211, 255, 1)",
      "name": "Annotations & Alerts", "type": "dashboard"
    }
  ]},

  "templating": {
    "list": [
      {
        "type": "datasource",
        "name": "DS_PROMETHEUS",
        "label": "Datasource",
        "query": "prometheus",
        "current": { "selected": true },
        "hide": 0
      },
      {
        "type": "query",
        "name": "container",
        "label": "Container",
        "datasource": "${DS_PROMETHEUS}",
        "includeAll": true,
        "multi": false,
        "query": "label_values(container_memory_usage_bytes{image!=\"\",name!=\"\"}, name)",
        "refresh": 1,
        "current": { "selected": true, "text": "All", "value": "$__all" }
      }
    ]
  },

  "time": { "from": "now-6h", "to": "now" },
  "timepicker": { "refresh_intervals": ["5s","10s","15s","30s","1m","5m","15m"] },

  "panels": [

    {
      "type": "gauge",
      "title": "CPU host (%)",
      "datasource": "${DS_PROMETHEUS}",
      "gridPos": { "h": 5, "w": 6, "x": 0, "y": 0 },
      "targets": [
        {
          "refId": "A",
          "expr": "100 - (avg by (instance) (irate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent","min": 0,"max": 100,
          "thresholds": { "mode": "absolute","steps": [
            { "color": "green" }, { "color": "orange", "value": 70 }, { "color": "red", "value": 90 }
          ]}
        }
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "values": false } }
    },
    {
      "type": "gauge",
      "title": "Memória host (usada)",
      "datasource": "${DS_PROMETHEUS}",
      "gridPos": { "h": 5, "w": 6, "x": 6, "y": 0 },
      "targets": [
        { "refId": "A", "expr": "(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes)" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "bytes",
          "min": 0,
          "max": 68719476736,
          "thresholds": { "mode": "absolute","steps": [
            { "color": "green" }, { "color": "orange", "value": 51539607552 }, { "color": "red", "value": 60129542144 }
          ]}
        }
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "values": false } }
    },
    {
      "type": "gauge",
      "title": "Disco raiz (/) — usado",
      "datasource": "${DS_PROMETHEUS}",
      "gridPos": { "h": 5, "w": 6, "x": 12, "y": 0 },
      "targets": [
        {
          "refId": "A",
          "expr": "node_filesystem_size_bytes{mountpoint=\"/\",fstype!~\"tmpfs|overlay|squashfs\"} - node_filesystem_avail_bytes{mountpoint=\"/\",fstype!~\"tmpfs|overlay|squashfs\"}"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "bytes" } },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "values": false } }
    },
    {
      "type": "gauge",
      "title": "Docker dir (/usr/lib/docker) — usado",
      "datasource": "${DS_PROMETHEUS}",
      "gridPos": { "h": 5, "w": 6, "x": 18, "y": 0 },
      "targets": [
        {
          "refId": "A",
          "expr": "node_filesystem_size_bytes{mountpoint=\"/usr/lib/docker\",fstype!~\"tmpfs|overlay|squashfs\"} - node_filesystem_avail_bytes{mountpoint=\"/usr/lib/docker\",fstype!~\"tmpfs|overlay|squashfs\"}"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "bytes" } },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "values": false } }
    },

    {
      "type": "stat",
      "title": "Rede host — RX (B/s, 5m avg)",
      "datasource": "${DS_PROMETHEUS}",
      "gridPos": { "h": 4, "w": 12, "x": 0, "y": 5 },
      "targets": [
        { "refId": "A", "expr": "sum(rate(node_network_receive_bytes_total{device!~\"lo|veth.*\"}[5m]))" }
      ],
      "fieldConfig": { "defaults": { "unit": "bytespersecond", "decimals": 2 } },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } }
    },
    {
      "type": "stat",
      "title": "Rede host — TX (B/s, 5m avg)",
      "datasource": "${DS_PROMETHEUS}",
      "gridPos": { "h": 4, "w": 12, "x": 12, "y": 5 },
      "targets": [
        { "refId": "A", "expr": "sum(rate(node_network_transmit_bytes_total{device!~\"lo|veth.*\"}[5m]))" }
      ],
      "fieldConfig": { "defaults": { "unit": "bytespersecond", "decimals": 2 } },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } }
    },

    {
      "type": "stat",
      "title": "Containers — Running / Stopped / Paused",
      "datasource": "${DS_PROMETHEUS}",
      "gridPos": { "h": 4, "w": 10, "x": 0, "y": 9 },
      "targets": [
        { "refId": "A", "expr": "engine_daemon_container_states_running{job=\"docker\"}" },
        { "refId": "B", "expr": "engine_daemon_container_states_stopped{job=\"docker\"}" },
        { "refId": "C", "expr": "engine_daemon_container_states_paused{job=\"docker\"}" }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "values": true }, "orientation": "horizontal" }
    },
    {
      "type": "stat",
      "title": "Imagens Docker",
      "datasource": "${DS_PROMETHEUS}",
      "gridPos": { "h": 4, "w": 6, "x": 10, "y": 9 },
      "targets": [
        { "refId": "A", "expr": "engine_daemon_images{job=\"docker\"}" }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"], "values": false } }
    },
    {
      "type": "stat",
      "title": "Uptime do Docker",
      "datasource": "${DS_PROMETHEUS}",
      "gridPos": { "h": 4, "w": 8, "x": 16, "y": 9 },
      "targets": [
        { "refId": "A", "expr": "time() - process_start_time_seconds{job=\"docker\"}" }
      ],
      "fieldConfig": { "defaults": { "unit": "s", "decimals": 0 } },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } }
    },

    {
      "type": "bargauge",
      "title": "Memória por Container (Top 10)",
      "datasource": "${DS_PROMETHEUS}",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 13 },
      "targets": [
        {
          "refId": "A",
          "expr": "topk(10, max by (name) (container_memory_usage_bytes{image!=\"\",name!=\"\"}))"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "bytes" } },
      "options": { "displayMode": "basic", "orientation": "horizontal", "reduceOptions": { "calcs": ["lastNotNull"], "values": true } }
    },
    {
      "type": "bargauge",
      "title": "CPU por Container (Top 10, cores @5m)",
      "datasource": "${DS_PROMETHEUS}",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 13 },
      "targets": [
        {
          "refId": "A",
          "expr": "topk(10, sum by (name) (rate(container_cpu_usage_seconds_total{image!=\"\",name!=\"\"}[5m])))"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "cores", "decimals": 2 } },
      "options": { "displayMode": "basic", "orientation": "horizontal", "reduceOptions": { "calcs": ["lastNotNull"], "values": true } }
    },

    {
      "type": "timeseries",
      "title": "Container selecionado — CPU (cores) e Memória (bytes)",
      "datasource": "${DS_PROMETHEUS}",
      "gridPos": { "h": 9, "w": 24, "x": 0, "y": 21 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (name) (rate(container_cpu_usage_seconds_total{name=~\"$container\",image!=\"\"}[5m]))",
          "legendFormat": "CPU cores — {{name}}"
        },
        {
          "refId": "B",
          "expr": "max by (name) (container_memory_usage_bytes{name=~\"$container\",image!=\"\"})",
          "legendFormat": "Mem bytes — {{name}}"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "short" } },
      "options": { "legend": { "displayMode": "list", "placement": "bottom" } }
    }
  ]
}
