# HTTP -> HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name mrqz.me www.mrqz.me;
    return 301 https://mrqz.me$request_uri;
}

# HTTPS - site estático
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;

    server_name mrqz.me;

    # TLS do site
    include /etc/nginx/snippets/ssl-mrqz.conf;

    # Raiz do site
    root /var/www/mrqz.me;
    index index.html;

    # Segurança leve (opcional)
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;

    # Cache estático simples
    location ~* \.(?:png|jpg|jpeg|gif|svg|webp|ico|css|js)$ {
        access_log off;
        expires 7d;
        add_header Cache-Control "public, max-age=604800, immutable";
        try_files $uri =404;
    }

    # HTML e demais (sem cache agressivo)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # PORTAINER: https://mrqz.me/container
    location ^~ /container/ {
        # Portainer com --base-url=/container PRECISA que o proxy retire o prefixo
        # por isso usamos rewrite para o backend ver "/"
        rewrite ^/container/(.*)$ /$1 break;
    
        proxy_pass http://portainer:9000/;
        include /etc/nginx/snippets/proxy-common.conf;
    
        proxy_set_header X-Forwarded-Prefix /container;
        proxy_set_header X-Forwarded-Host   $host;
        proxy_set_header X-Forwarded-Proto  $scheme;
        proxy_set_header X-Forwarded-Port   443;
    
        # Corrige Location de redirecionamentos
        proxy_redirect ~^http(s)?://[^/]+(/.*)$ https://$host/container$2;
    }

    # GRAFANA: https://mrqz.me/painel
    # Redireciona /painel (sem /) para /painel/ para evitar loop
    location = /painel { return 308 /painel/; }
    
    location ^~ /painel/ {
        include /etc/nginx/snippets/proxy-common.conf;
    
        # Encaminha mantendo o subpath (Grafana já foi ajustado para servir sob /painel)
        # NÃO coloque barra no final => preserva /painel/... para o backend
        proxy_pass http://grafana:3000;
    
        # Cabeçalhos úteis
        proxy_set_header X-Forwarded-Prefix /painel;
        proxy_set_header X-Forwarded-Host   $host;
        proxy_set_header X-Forwarded-Proto  $scheme;
        proxy_set_header X-Forwarded-Port   443;
    
        # Corrige redirecionamentos absolutos
        proxy_redirect ~^http(s)?://[^/]+(/.*)$ https://$host$2;
    }

    # PROMETHEUS: https://mrqz.me/metricas
    # Redireciona /metricas (sem /) para /metricas/ para evitar loop
    location = /metricas { return 308 /metricas/; }
    
    location ^~ /metricas/ {
        include /etc/nginx/snippets/proxy-common.conf;
    
        # Prometheus foi configurado c/ --web.external-url e --web.route-prefix /metricas
        # NÃO coloque barra no final => preserva /metricas/...
        proxy_pass http://prometheus:9090;
    
        # Segurança opcional (desabilitar frames, etc.)
        add_header X-Frame-Options SAMEORIGIN always;
    
        # Corrige redirecionamentos absolutos
        proxy_redirect ~^http(s)?://[^/]+(/.*)$ https://$host/metricas$2;
    }
}
